<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TikTok SMM Blaster</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface-2: #1a1a26;
    --surface-3: #22222f;
    --border: #2a2a3a;
    --border-hover: #3a3a4f;
    --text: #e8e8f0;
    --text-dim: #8888a0;
    --text-muted: #55556a;
    --accent: #ff3366;
    --accent-glow: rgba(255, 51, 102, 0.15);
    --accent-2: #00e5ff;
    --accent-2-glow: rgba(0, 229, 255, 0.12);
    --success: #00e676;
    --warning: #ffab00;
    --error: #ff5252;
    --radius: 10px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Ambient background */
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 20% 20%, rgba(255,51,102,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0,229,255,0.04) 0%, transparent 50%);
    z-index: 0;
    pointer-events: none;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo {
    width: 42px;
    height: 42px;
    background: linear-gradient(135deg, var(--accent), #cc2952);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -1px;
    box-shadow: 0 4px 20px rgba(255,51,102,0.25);
  }

  .header h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .header h1 span {
    color: var(--accent);
  }

  .balance-badge {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 16px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: var(--success);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .balance-badge::before {
    content: '‚óè';
    font-size: 8px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Config Section */
  .config-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .config-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .config-card label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  input, select {
    width: 100%;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  input::placeholder {
    color: var(--text-muted);
  }

  /* Profile Fetch Section */
  .fetch-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 24px;
  }

  .fetch-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .fetch-row .input-group {
    flex: 1;
  }

  .fetch-row label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    box-shadow: 0 2px 12px rgba(255,51,102,0.3);
  }

  .btn-primary:hover {
    background: #e62d5c;
    box-shadow: 0 4px 20px rgba(255,51,102,0.4);
    transform: translateY(-1px);
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .btn-secondary {
    background: var(--surface-3);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    border-color: var(--border-hover);
    background: var(--border);
  }

  .btn-blast {
    background: linear-gradient(135deg, var(--accent), #cc2952);
    color: white;
    font-size: 15px;
    font-weight: 700;
    padding: 16px 40px;
    box-shadow: 0 4px 24px rgba(255,51,102,0.35);
    letter-spacing: 0.5px;
  }

  .btn-blast:hover {
    box-shadow: 0 6px 32px rgba(255,51,102,0.5);
    transform: translateY(-2px);
  }

  .btn-blast:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  /* Services Config */
  .services-section {
    margin-bottom: 24px;
  }

  .services-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .services-header h2 {
    font-size: 16px;
    font-weight: 600;
  }

  .service-row {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    display: grid;
    grid-template-columns: 1fr 120px 140px 40px 40px;
    gap: 12px;
    align-items: center;
    margin-bottom: 8px;
    transition: border-color 0.2s;
  }

  .service-row:hover {
    border-color: var(--border-hover);
  }

  .service-row label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text-muted);
    margin-bottom: 6px;
    display: block;
  }

  .service-row input {
    padding: 10px 12px;
  }

  .service-toggle {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
  }

  .service-toggle.active {
    background: var(--accent-glow);
    border-color: var(--accent);
    color: var(--accent);
  }

  .service-remove {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s;
  }

  .service-remove:hover {
    background: rgba(255,82,82,0.12);
    border-color: var(--error);
    color: var(--error);
  }

  .services-tip {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 12px;
    font-family: 'JetBrains Mono', monospace;
  }

  .services-tip strong {
    color: var(--accent-2);
  }

  .add-service-btn {
    width: 100%;
    padding: 12px;
    background: var(--surface);
    border: 1px dashed var(--border);
    border-radius: var(--radius);
    color: var(--text-muted);
    cursor: pointer;
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    transition: all 0.2s;
  }

  .add-service-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-glow);
  }

  /* Videos Table */
  .videos-section {
    margin-bottom: 24px;
  }

  .videos-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .videos-header h2 {
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .count-badge {
    background: var(--surface-3);
    border-radius: 6px;
    padding: 3px 10px;
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent-2);
  }

  .select-actions {
    display: flex;
    gap: 8px;
  }

  .videos-table {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .video-row {
    display: grid;
    grid-template-columns: 40px 1fr 140px;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
  }

  .video-row:last-child {
    border-bottom: none;
  }

  .video-row:hover {
    background: var(--surface-2);
  }

  .video-row.selected {
    background: var(--accent-glow);
  }

  .video-row input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--accent);
    cursor: pointer;
  }

  .video-link {
    color: var(--text-dim);
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .video-link:hover {
    color: var(--accent-2);
  }

  .video-status {
    text-align: right;
    font-size: 11px;
  }

  .status-idle { color: var(--text-muted); }
  .status-pending { color: var(--warning); }
  .status-sent { color: var(--success); }
  .status-error { color: var(--error); }

  .empty-state {
    padding: 60px 20px;
    text-align: center;
    color: var(--text-muted);
  }

  .empty-state .icon {
    font-size: 32px;
    margin-bottom: 12px;
    opacity: 0.5;
  }

  /* Blast Section */
  .blast-section {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
  }

  .blast-info {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .blast-stat {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: var(--text-dim);
  }

  .blast-stat strong {
    color: var(--text);
  }

  /* Log */
  .log-section {
    margin-top: 24px;
  }

  .log-section h2 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
  }

  .log-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    line-height: 1.8;
  }

  .log-box::-webkit-scrollbar {
    width: 6px;
  }
  .log-box::-webkit-scrollbar-track {
    background: transparent;
  }
  .log-box::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  .log-entry { color: var(--text-dim); }
  .log-entry.success { color: var(--success); }
  .log-entry.error { color: var(--error); }
  .log-entry.info { color: var(--accent-2); }
  .log-entry .timestamp { color: var(--text-muted); margin-right: 8px; }

  /* Spinner */
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.2);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    display: inline-block;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .config-grid { grid-template-columns: 1fr; }
    .service-row { grid-template-columns: 1fr; }
    .blast-section { flex-direction: column; gap: 16px; }
    .header { flex-direction: column; gap: 12px; align-items: flex-start; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">‚ö°</div>
      <h1>TikTok <span>SMM Blaster</span></h1>
    </div>
    <div class="balance-badge" id="balanceDisplay">Balance: ‚Äî</div>
  </div>

  <!-- API Config -->
  <div class="config-grid">
    <div class="config-card">
      <label>JAP API Key</label>
      <input type="password" id="apiKey" placeholder="Enter your JustAnotherPanel API key" />
    </div>
    <div class="config-card" style="display:flex; align-items:flex-end; gap:12px;">
      <div style="flex:1">
        <label>API URL</label>
        <input type="text" id="apiUrl" value="https://justanotherpanel.com/api/v2" />
      </div>
      <button class="btn btn-secondary" onclick="fetchBalance()">Check Balance</button>
    </div>
  </div>

  <!-- Fetch Profile -->
  <div class="fetch-section">
    <div class="fetch-row">
      <div class="input-group">
        <label>TikTok Profile URL</label>
        <input type="text" id="profileUrl" placeholder="https://www.tiktok.com/@yourusername" />
      </div>
      <button class="btn btn-primary" id="fetchBtn" onclick="scrapeTikTok()">
        ‚ö° Scrape Videos
      </button>
    </div>
    <div id="scrapeStatus" style="margin-top:12px; display:none;">
      <div style="display:flex; align-items:center; gap:10px;">
        <span class="spinner"></span>
        <span id="scrapeMsg" style="font-size:13px; color:var(--accent-2); font-family:'JetBrains Mono',monospace;">Scraping...</span>
      </div>
    </div>
    <details style="margin-top:12px;">
      <summary style="font-size:12px; color:var(--text-muted); cursor:pointer;">Or paste links manually</summary>
      <div style="margin-top:10px;">
        <textarea id="linksInput" rows="4" style="width:100%; background:var(--surface-2); border:1px solid var(--border); border-radius:8px; padding:12px 14px; color:var(--text); font-family:'JetBrains Mono',monospace; font-size:12px; outline:none; resize:vertical;" placeholder="https://www.tiktok.com/@user/video/1234567890&#10;https://www.tiktok.com/@user/video/0987654321"></textarea>
        <button class="btn btn-secondary" style="margin-top:10px;" onclick="loadLinks()">Load Links</button>
      </div>
    </details>
  </div>

  <!-- Services -->
  <div class="services-section">
    <div class="services-header">
      <h2>Services</h2>
    </div>
    <div class="services-tip">üí° Quick IDs ‚Äî Saves: <strong>54</strong> ¬∑ Likes: <strong>10024</strong></div>
    <div id="servicesList">
      <div class="service-row">
        <div>
          <label>Service Name</label>
          <input type="text" value="TikTok Likes" class="svc-name" />
        </div>
        <div>
          <label>Service ID</label>
          <input type="text" value="10024" class="svc-id" />
        </div>
        <div>
          <label>Quantity</label>
          <input type="number" value="500" class="svc-qty" />
        </div>
        <button class="service-toggle active" onclick="toggleService(this)" title="Toggle on/off">‚úì</button>
        <button class="service-remove" onclick="removeService(this)" title="Remove service">‚úï</button>
      </div>
      <div class="service-row">
        <div>
          <label>Service Name</label>
          <input type="text" value="TikTok Saves" class="svc-name" />
        </div>
        <div>
          <label>Service ID</label>
          <input type="text" value="54" class="svc-id" />
        </div>
        <div>
          <label>Quantity</label>
          <input type="number" value="200" class="svc-qty" />
        </div>
        <button class="service-toggle active" onclick="toggleService(this)" title="Toggle on/off">‚úì</button>
        <button class="service-remove" onclick="removeService(this)" title="Remove service">‚úï</button>
      </div>
    </div>
    <button class="add-service-btn" onclick="addService()">+ Add Service</button>
  </div>

  <!-- Videos List -->
  <div class="videos-section">
    <div class="videos-header">
      <h2>Videos <span class="count-badge" id="videoCount">0</span></h2>
      <div class="select-actions">
        <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
        <button class="btn btn-secondary" onclick="deselectAll()">Deselect All</button>
      </div>
    </div>
    <div class="videos-table" id="videosTable">
      <div class="empty-state">
        <div class="icon">üìã</div>
        <p>No videos loaded. Paste links above and click "Load Links".</p>
      </div>
    </div>
  </div>

  <!-- Blast Controls -->
  <div class="blast-section">
    <div class="blast-info">
      <div class="blast-stat">Selected: <strong id="selectedCount">0</strong></div>
      <div class="blast-stat">Services: <strong id="activeServices">0</strong></div>
      <div class="blast-stat">Total Orders: <strong id="totalOrders">0</strong></div>
    </div>
    <button class="btn btn-blast" id="blastBtn" onclick="massBlast()" disabled>
      ‚ö° MASS SEND
    </button>
  </div>

  <!-- Log -->
  <div class="log-section">
    <h2>Activity Log</h2>
    <div class="log-box" id="logBox">
      <div class="log-entry info"><span class="timestamp">[--:--:--]</span> Dashboard ready. Configure API key and load videos to begin.</div>
    </div>
  </div>
</div>

<script>
  // State
  let videos = [];

  // Helpers
  function ts() {
    return new Date().toLocaleTimeString('en-US', { hour12: false });
  }

  function log(msg, type = '') {
    const box = document.getElementById('logBox');
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.innerHTML = `<span class="timestamp">[${ts()}]</span> ${msg}`;
    box.appendChild(entry);
    box.scrollTop = box.scrollHeight;
  }

  function getApiKey() {
    return document.getElementById('apiKey').value.trim();
  }

  function getApiUrl() {
    return document.getElementById('apiUrl').value.trim();
  }

  // JAP API Call (via CORS proxy since it's a browser dashboard)
  async function japApi(params) {
    const apiKey = getApiKey();
    if (!apiKey) { log('No API key set!', 'error'); return null; }

    const body = new URLSearchParams({ key: apiKey, ...params });

    try {
      const res = await fetch(getApiUrl(), {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
      });
      return await res.json();
    } catch (e) {
      log(`API Error: ${e.message}`, 'error');
      return null;
    }
  }

  // Fetch Balance
  async function fetchBalance() {
    log('Fetching balance...');
    const data = await japApi({ action: 'balance' });
    if (data && data.balance) {
      document.getElementById('balanceDisplay').textContent = `Balance: $${parseFloat(data.balance).toFixed(2)}`;
      log(`Balance: $${parseFloat(data.balance).toFixed(2)}`, 'success');
    } else {
      log('Failed to fetch balance. Check API key.', 'error');
    }
  }

  // Built-in TikTok Scraper
  async function scrapeTikTok() {
    const profileUrl = document.getElementById('profileUrl').value.trim();
    if (!profileUrl || !profileUrl.includes('tiktok.com/@')) {
      log('Enter a valid TikTok profile URL (e.g. https://www.tiktok.com/@username)', 'error');
      return;
    }

    const fetchBtn = document.getElementById('fetchBtn');
    const scrapeStatus = document.getElementById('scrapeStatus');
    const scrapeMsg = document.getElementById('scrapeMsg');

    fetchBtn.disabled = true;
    fetchBtn.innerHTML = '<span class="spinner"></span> Scraping...';
    scrapeStatus.style.display = 'block';
    scrapeMsg.textContent = 'Opening profile...';
    log(`Scraping profile: ${profileUrl}`, 'info');

    // Open popup
    const popup = window.open(profileUrl, 'tiktok_scraper', 'width=1100,height=800');

    if (!popup) {
      log('Popup blocked! Allow popups for this site and try again.', 'error');
      fetchBtn.disabled = false;
      fetchBtn.innerHTML = '‚ö° Scrape Videos';
      scrapeStatus.style.display = 'none';
      return;
    }

    // Wait for page to load
    scrapeMsg.textContent = 'Waiting for page to load...';
    await new Promise(r => setTimeout(r, 4000));

    try {
      // Inject the auto-scroll scraper into the popup
      const scraperCode = `
        (async () => {
          // Auto-scroll to load all videos
          let prevHeight = 0;
          let stuckCount = 0;
          while (stuckCount < 3) {
            window.scrollTo(0, document.body.scrollHeight);
            await new Promise(r => setTimeout(r, 1500));
            if (document.body.scrollHeight === prevHeight) {
              stuckCount++;
            } else {
              stuckCount = 0;
            }
            prevHeight = document.body.scrollHeight;
          }

          // Collect all video links
          const links = [...document.querySelectorAll('a[href*="/video/"]')]
            .map(a => a.href)
            .filter((v, i, arr) => arr.indexOf(v) === i);

          // Send back to parent
          window.opener.postMessage({ type: 'tiktok_scrape_result', links: links }, '*');
        })();
      `;

      // Listen for results from the popup
      const resultPromise = new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('Scrape timed out after 120s'));
        }, 120000);

        window.addEventListener('message', function handler(e) {
          if (e.data && e.data.type === 'tiktok_scrape_result') {
            clearTimeout(timeout);
            window.removeEventListener('message', handler);
            resolve(e.data.links);
          }
        });
      });

      scrapeMsg.textContent = 'Scrolling & collecting videos...';
      log('Injecting scraper ‚Äî auto-scrolling to load all videos...', 'info');

      // Inject the script
      popup.eval(scraperCode);

      // Wait for results
      const links = await resultPromise;

      // Close popup
      popup.close();

      if (links.length === 0) {
        log('No videos found on this profile.', 'error');
      } else {
        videos = links.map(link => ({
          url: link,
          selected: true,
          status: 'idle',
          orders: []
        }));
        renderVideos();
        updateStats();
        log(`‚úì Scraped ${links.length} videos!`, 'success');
      }

    } catch (e) {
      log(`Scrape failed: ${e.message}`, 'error');
      log('Fallback: use the manual paste option below, or copy this to the popup console:', 'info');
      log(`Script: check the "paste links manually" section`, 'info');
      try { popup.close(); } catch(_) {}
    }

    fetchBtn.disabled = false;
    fetchBtn.innerHTML = '‚ö° Scrape Videos';
    scrapeStatus.style.display = 'none';
  }

  // Load pasted links
  function loadLinks() {
    const raw = document.getElementById('linksInput').value.trim();
    if (!raw) return;

    const links = raw.split('\n')
      .map(l => l.trim())
      .filter(l => l.includes('tiktok.com') && l.includes('/video/'));

    if (links.length === 0) {
      log('No valid TikTok video links found.', 'error');
      return;
    }

    videos = links.map(link => ({
      url: link,
      selected: true,
      status: 'idle',
      orders: []
    }));

    renderVideos();
    updateStats();
    log(`Loaded ${videos.length} videos.`, 'success');
  }

  // Render video list
  function renderVideos() {
    const container = document.getElementById('videosTable');

    if (videos.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="icon">üìã</div><p>No videos loaded.</p></div>`;
      return;
    }

    container.innerHTML = videos.map((v, i) => `
      <div class="video-row ${v.selected ? 'selected' : ''}" data-index="${i}">
        <input type="checkbox" ${v.selected ? 'checked' : ''} onchange="toggleVideo(${i})" />
        <a href="${v.url}" target="_blank" class="video-link">${v.url}</a>
        <div class="video-status status-${v.status}">${statusLabel(v)}</div>
      </div>
    `).join('');

    document.getElementById('videoCount').textContent = videos.length;
  }

  function statusLabel(v) {
    if (v.status === 'idle') return '‚Äî';
    if (v.status === 'pending') return '‚è≥ Sending...';
    if (v.status === 'sent') return `‚úì ${v.orders.length} orders`;
    if (v.status === 'error') return '‚úó Failed';
    return v.status;
  }

  function toggleVideo(i) {
    videos[i].selected = !videos[i].selected;
    renderVideos();
    updateStats();
  }

  function selectAll() {
    videos.forEach(v => v.selected = true);
    renderVideos();
    updateStats();
  }

  function deselectAll() {
    videos.forEach(v => v.selected = false);
    renderVideos();
    updateStats();
  }

  // Services
  function toggleService(btn) {
    btn.classList.toggle('active');
    btn.textContent = btn.classList.contains('active') ? '‚úì' : '‚úó';
    updateStats();
  }

  function removeService(btn) {
    const row = btn.closest('.service-row');
    row.remove();
    updateStats();
  }

  function addService() {
    const list = document.getElementById('servicesList');
    const row = document.createElement('div');
    row.className = 'service-row';
    row.innerHTML = `
      <div>
        <label>Service Name</label>
        <input type="text" placeholder="e.g. TikTok Views" class="svc-name" />
      </div>
      <div>
        <label>Service ID</label>
        <input type="text" placeholder="e.g. 9999" class="svc-id" />
      </div>
      <div>
        <label>Quantity</label>
        <input type="number" value="500" class="svc-qty" />
      </div>
      <button class="service-toggle active" onclick="toggleService(this)" title="Toggle on/off">‚úì</button>
      <button class="service-remove" onclick="removeService(this)" title="Remove service">‚úï</button>
    `;
    list.appendChild(row);
    updateStats();
  }

  function getActiveServices() {
    const rows = document.querySelectorAll('.service-row');
    const services = [];
    rows.forEach(row => {
      const toggle = row.querySelector('.service-toggle');
      if (!toggle.classList.contains('active')) return;
      const id = row.querySelector('.svc-id').value.trim();
      const qty = parseInt(row.querySelector('.svc-qty').value) || 0;
      const name = row.querySelector('.svc-name').value.trim();
      if (id && qty > 0) {
        services.push({ id, qty, name });
      }
    });
    return services;
  }

  function updateStats() {
    const selected = videos.filter(v => v.selected).length;
    const services = getActiveServices();
    const total = selected * services.length;

    document.getElementById('selectedCount').textContent = selected;
    document.getElementById('activeServices').textContent = services.length;
    document.getElementById('totalOrders').textContent = total;
    document.getElementById('blastBtn').disabled = total === 0;
  }

  // Re-calc on input changes
  document.addEventListener('input', (e) => {
    if (e.target.closest('.service-row')) updateStats();
  });

  // MASS BLAST
  async function massBlast() {
    const apiKey = getApiKey();
    if (!apiKey) { log('Set your API key first!', 'error'); return; }

    const services = getActiveServices();
    if (services.length === 0) { log('No active services configured.', 'error'); return; }

    const selected = videos.filter(v => v.selected);
    if (selected.length === 0) { log('No videos selected.', 'error'); return; }

    const total = selected.length * services.length;
    log(`üöÄ Starting mass send: ${selected.length} videos √ó ${services.length} services = ${total} orders`, 'info');

    document.getElementById('blastBtn').disabled = true;
    document.getElementById('blastBtn').innerHTML = '<span class="spinner"></span> SENDING...';

    let successCount = 0;
    let errorCount = 0;

    for (const video of selected) {
      video.status = 'pending';
      video.orders = [];
      renderVideos();

      let videoSuccess = true;

      for (const svc of services) {
        try {
          const data = await japApi({
            action: 'add',
            service: svc.id,
            link: video.url,
            quantity: svc.qty
          });

          if (data && data.order) {
            video.orders.push({ service: svc.name, orderId: data.order });
            log(`‚úì Order #${data.order} ‚Äî ${svc.name} (${svc.qty}) ‚Üí ...${video.url.slice(-20)}`, 'success');
            successCount++;
          } else {
            const errMsg = data?.error || 'Unknown error';
            log(`‚úó Failed: ${svc.name} ‚Üí ...${video.url.slice(-20)} ‚Äî ${errMsg}`, 'error');
            errorCount++;
            videoSuccess = false;
          }

          // Small delay to avoid rate limiting
          await new Promise(r => setTimeout(r, 300));

        } catch (e) {
          log(`‚úó Error: ${svc.name} ‚Üí ${e.message}`, 'error');
          errorCount++;
          videoSuccess = false;
        }
      }

      video.status = videoSuccess ? 'sent' : 'error';
      renderVideos();
    }

    log(`üèÅ Done! ${successCount} successful, ${errorCount} failed out of ${total} total.`, successCount > 0 ? 'success' : 'error');

    document.getElementById('blastBtn').innerHTML = '‚ö° MASS SEND';
    document.getElementById('blastBtn').disabled = false;

    // Refresh balance
    fetchBalance();
  }
</script>
</body>
</html>
