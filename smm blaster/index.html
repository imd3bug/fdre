// ==UserScript==
// @name         TikTok SMM Blaster
// @namespace    https://justanotherpanel.com
// @version      1.0
// @description  TikTok bulk order dashboard injected into JAP. Auto-grabs API key, scrapes TikTok profiles, mass sends orders.
// @match        https://justanotherpanel.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @connect      www.tiktok.com
// @connect      justanotherpanel.com
// @run-at       document-idle
// ==/UserScript==

(function() {
  'use strict';

  // ‚îÄ‚îÄ‚îÄ Inject CSS ‚îÄ‚îÄ‚îÄ
  GM_addStyle(`
    #blaster-toggle {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 99999;
      width: 52px;
      height: 52px;
      border-radius: 14px;
      background: linear-gradient(135deg, #ff3366, #cc2952);
      border: none;
      color: white;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 24px rgba(255,51,102,0.4);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #blaster-toggle:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 32px rgba(255,51,102,0.6);
    }

    #blaster-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 100000;
      justify-content: center;
      align-items: center;
    }
    #blaster-overlay.open { display: flex; }

    #blaster-panel {
      width: 780px;
      max-height: 88vh;
      background: #0c0c14;
      border: 1px solid #2a2a3a;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 24px 80px rgba(0,0,0,0.7);
    }

    #blaster-panel * { box-sizing: border-box; margin: 0; padding: 0; }

    .bl-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 24px;
      border-bottom: 1px solid #2a2a3a;
      background: #10101a;
    }
    .bl-header-left { display: flex; align-items: center; gap: 12px; }
    .bl-logo {
      width: 34px; height: 34px;
      background: linear-gradient(135deg, #ff3366, #cc2952);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
      box-shadow: 0 3px 12px rgba(255,51,102,0.3);
    }
    .bl-title { font-size: 16px; font-weight: 700; color: #e8e8f0; font-family: 'Segoe UI',sans-serif; }
    .bl-title span { color: #ff3366; }
    .bl-balance {
      background: #1a1a26;
      border: 1px solid #2a2a3a;
      border-radius: 6px;
      padding: 6px 14px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #00e676;
    }
    .bl-close {
      width: 32px; height: 32px;
      border-radius: 6px;
      border: 1px solid #2a2a3a;
      background: #1a1a26;
      color: #8888a0;
      cursor: pointer;
      font-size: 16px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .bl-close:hover { background: rgba(255,82,82,0.15); border-color: #ff5252; color: #ff5252; }

    .bl-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
    }
    .bl-body::-webkit-scrollbar { width: 5px; }
    .bl-body::-webkit-scrollbar-track { background: transparent; }
    .bl-body::-webkit-scrollbar-thumb { background: #2a2a3a; border-radius: 3px; }

    .bl-section {
      background: #12121a;
      border: 1px solid #2a2a3a;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .bl-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #55556a;
      margin-bottom: 6px;
      font-family: 'Segoe UI',sans-serif;
    }

    .bl-input, .bl-textarea {
      width: 100%;
      background: #1a1a26;
      border: 1px solid #2a2a3a;
      border-radius: 6px;
      padding: 9px 12px;
      color: #e8e8f0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    .bl-input:focus, .bl-textarea:focus { border-color: #ff3366; }
    .bl-input::placeholder, .bl-textarea::placeholder { color: #55556a; }
    .bl-textarea { resize: vertical; min-height: 60px; }

    .bl-row { display: flex; gap: 10px; align-items: flex-end; }
    .bl-row > .bl-grow { flex: 1; }

    .bl-btn {
      padding: 9px 18px;
      border: none;
      border-radius: 6px;
      font-family: 'Segoe UI',sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .bl-btn-sm { padding: 6px 12px; font-size: 11px; }
    .bl-btn-primary { background: #ff3366; color: white; }
    .bl-btn-primary:hover { background: #e62d5c; }
    .bl-btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
    .bl-btn-secondary { background: #22222f; color: #e8e8f0; border: 1px solid #2a2a3a; }
    .bl-btn-secondary:hover { background: #2a2a3a; }
    .bl-btn-blast {
      background: linear-gradient(135deg, #ff3366, #cc2952);
      color: white;
      font-size: 14px;
      font-weight: 700;
      padding: 12px 32px;
      box-shadow: 0 4px 20px rgba(255,51,102,0.35);
    }
    .bl-btn-blast:hover { box-shadow: 0 6px 28px rgba(255,51,102,0.5); transform: translateY(-1px); }
    .bl-btn-blast:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .bl-tip {
      background: #1a1a26;
      border: 1px solid #2a2a3a;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 11px;
      color: #8888a0;
      margin-bottom: 10px;
      font-family: 'Courier New', monospace;
    }
    .bl-tip strong { color: #00e5ff; }

    .bl-svc-row {
      display: grid;
      grid-template-columns: 1fr 90px 90px 30px 30px;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      background: #1a1a26;
      border: 1px solid #2a2a3a;
      border-radius: 6px;
      margin-bottom: 6px;
    }
    .bl-svc-row .bl-input { padding: 7px 10px; font-size: 11px; }

    .bl-svc-btn {
      width: 30px; height: 30px;
      border-radius: 5px;
      border: 1px solid #2a2a3a;
      background: #22222f;
      color: #55556a;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px;
      transition: all 0.2s;
    }
    .bl-svc-btn.active { background: rgba(255,51,102,0.12); border-color: #ff3366; color: #ff3366; }
    .bl-svc-btn.remove:hover { background: rgba(255,82,82,0.12); border-color: #ff5252; color: #ff5252; }

    .bl-add-svc {
      width: 100%;
      padding: 8px;
      background: transparent;
      border: 1px dashed #2a2a3a;
      border-radius: 6px;
      color: #55556a;
      cursor: pointer;
      font-family: 'Segoe UI',sans-serif;
      font-size: 11px;
      transition: all 0.2s;
    }
    .bl-add-svc:hover { border-color: #ff3366; color: #ff3366; }

    .bl-videos-table {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #2a2a3a;
      border-radius: 6px;
    }
    .bl-videos-table::-webkit-scrollbar { width: 4px; }
    .bl-videos-table::-webkit-scrollbar-thumb { background: #2a2a3a; border-radius: 2px; }

    .bl-vid-row {
      display: grid;
      grid-template-columns: 26px 1fr 90px;
      align-items: center;
      padding: 7px 10px;
      border-bottom: 1px solid #1a1a26;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #8888a0;
      transition: background 0.15s;
    }
    .bl-vid-row:last-child { border-bottom: none; }
    .bl-vid-row:hover { background: #1a1a26; }
    .bl-vid-row.selected { background: rgba(255,51,102,0.08); }
    .bl-vid-row input[type="checkbox"] { width: 13px; height: 13px; accent-color: #ff3366; cursor: pointer; }
    .bl-vid-link { color: #8888a0; text-decoration: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .bl-vid-link:hover { color: #00e5ff; }
    .bl-vid-status { text-align: right; font-size: 10px; }
    .st-idle { color: #55556a; }
    .st-pending { color: #ffab00; }
    .st-sent { color: #00e676; }
    .st-error { color: #ff5252; }

    .bl-empty { padding: 24px; text-align: center; color: #55556a; font-size: 12px; font-family: 'Segoe UI',sans-serif; }

    .bl-blast-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      border-top: 1px solid #2a2a3a;
      background: #10101a;
    }
    .bl-stats {
      display: flex;
      gap: 16px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #8888a0;
    }
    .bl-stats strong { color: #e8e8f0; }

    .bl-log {
      background: #12121a;
      border: 1px solid #2a2a3a;
      border-radius: 10px;
      padding: 12px;
      max-height: 130px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      line-height: 1.7;
    }
    .bl-log::-webkit-scrollbar { width: 4px; }
    .bl-log::-webkit-scrollbar-thumb { background: #2a2a3a; border-radius: 2px; }
    .bl-log-entry { color: #8888a0; }
    .bl-log-entry.success { color: #00e676; }
    .bl-log-entry.error { color: #ff5252; }
    .bl-log-entry.info { color: #00e5ff; }
    .bl-log-ts { color: #55556a; margin-right: 6px; }

    .bl-scrape-status {
      display: none;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      font-size: 11px;
      color: #00e5ff;
      font-family: 'Courier New', monospace;
    }
    .bl-scrape-status.visible { display: flex; }

    .bl-spinner {
      width: 13px; height: 13px;
      border: 2px solid rgba(255,255,255,0.12);
      border-top-color: white;
      border-radius: 50%;
      animation: bl-spin 0.6s linear infinite;
      display: inline-block;
    }
    @keyframes bl-spin { to { transform: rotate(360deg); } }

    .bl-details summary {
      font-size: 11px;
      color: #55556a;
      cursor: pointer;
      margin-top: 8px;
      font-family: 'Segoe UI',sans-serif;
    }
    .bl-details summary:hover { color: #8888a0; }

    .bl-vids-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .bl-vids-header h3 {
      font-size: 13px;
      font-weight: 600;
      color: #e8e8f0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Segoe UI',sans-serif;
    }
    .bl-count {
      background: #22222f;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 11px;
      font-family: 'Courier New', monospace;
      color: #00e5ff;
    }

    .bl-key-status {
      font-size: 11px;
      margin-top: 6px;
      font-family: 'Courier New', monospace;
    }
    .bl-key-status.found { color: #00e676; }
    .bl-key-status.missing { color: #ff5252; }
  `);

  // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
  let videos = [];
  let apiKey = '';

  // ‚îÄ‚îÄ‚îÄ Build UI ‚îÄ‚îÄ‚îÄ
  const toggle = document.createElement('button');
  toggle.id = 'blaster-toggle';
  toggle.textContent = '‚ö°';
  toggle.title = 'TikTok SMM Blaster';
  document.body.appendChild(toggle);

  const overlay = document.createElement('div');
  overlay.id = 'blaster-overlay';
  overlay.innerHTML = `
    <div id="blaster-panel">
      <div class="bl-header">
        <div class="bl-header-left">
          <div class="bl-logo">‚ö°</div>
          <div class="bl-title">TikTok <span>Blaster</span></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="bl-balance" id="bl-balance">Balance: ‚Äî</div>
          <button class="bl-close" id="bl-close">‚úï</button>
        </div>
      </div>

      <div class="bl-body">
        <!-- API Key -->
        <div class="bl-section">
          <div class="bl-row">
            <div class="bl-grow">
              <label class="bl-label">JAP API Key</label>
              <input type="password" class="bl-input" id="bl-apikey" placeholder="Auto-detected or enter manually" />
            </div>
            <div>
              <label class="bl-label">&nbsp;</label>
              <button class="bl-btn bl-btn-secondary bl-btn-sm" id="bl-grab-key">üîë Auto-Grab</button>
            </div>
            <div>
              <label class="bl-label">&nbsp;</label>
              <button class="bl-btn bl-btn-secondary bl-btn-sm" id="bl-check-bal">Check</button>
            </div>
          </div>
          <div class="bl-key-status" id="bl-key-status"></div>
        </div>

        <!-- Scrape -->
        <div class="bl-section">
          <label class="bl-label">Scrape TikTok Profile</label>
          <div class="bl-row">
            <div class="bl-grow">
              <input type="text" class="bl-input" id="bl-profile" placeholder="https://www.tiktok.com/@username" />
            </div>
            <div>
              <button class="bl-btn bl-btn-primary" id="bl-scrape">‚ö° Scrape</button>
            </div>
          </div>
          <div class="bl-scrape-status" id="bl-scrape-status">
            <span class="bl-spinner"></span>
            <span id="bl-scrape-msg">Scraping...</span>
          </div>
          <details class="bl-details">
            <summary>Or paste links manually</summary>
            <div style="margin-top:8px;">
              <textarea class="bl-textarea" id="bl-links" placeholder="One link per line..."></textarea>
              <button class="bl-btn bl-btn-secondary bl-btn-sm" style="margin-top:6px;" id="bl-load-links">Load Links</button>
            </div>
          </details>
        </div>

        <!-- Services -->
        <div class="bl-section">
          <label class="bl-label">Services</label>
          <div class="bl-tip">üí° Quick IDs ‚Äî Saves: <strong>54</strong> ¬∑ Likes: <strong>10024</strong></div>
          <div id="bl-services">
            <div class="bl-svc-row">
              <input type="text" class="bl-input svc-name" value="TikTok Likes" placeholder="Name" />
              <input type="text" class="bl-input svc-id" value="10024" placeholder="ID" />
              <input type="number" class="bl-input svc-qty" value="500" placeholder="Qty" />
              <button class="bl-svc-btn active" data-action="toggle">‚úì</button>
              <button class="bl-svc-btn remove" data-action="remove">‚úï</button>
            </div>
            <div class="bl-svc-row">
              <input type="text" class="bl-input svc-name" value="TikTok Saves" placeholder="Name" />
              <input type="text" class="bl-input svc-id" value="54" placeholder="ID" />
              <input type="number" class="bl-input svc-qty" value="200" placeholder="Qty" />
              <button class="bl-svc-btn active" data-action="toggle">‚úì</button>
              <button class="bl-svc-btn remove" data-action="remove">‚úï</button>
            </div>
          </div>
          <button class="bl-add-svc" id="bl-add-svc">+ Add Service</button>
        </div>

        <!-- Videos -->
        <div class="bl-section">
          <div class="bl-vids-header">
            <h3>Videos <span class="bl-count" id="bl-vid-count">0</span></h3>
            <div style="display:flex;gap:6px;">
              <button class="bl-btn bl-btn-secondary bl-btn-sm" id="bl-sel-all">All</button>
              <button class="bl-btn bl-btn-secondary bl-btn-sm" id="bl-sel-none">None</button>
            </div>
          </div>
          <div class="bl-videos-table" id="bl-vid-table">
            <div class="bl-empty">No videos loaded yet.</div>
          </div>
        </div>

        <!-- Log -->
        <div class="bl-log" id="bl-log">
          <div class="bl-log-entry info"><span class="bl-log-ts">[--:--]</span> Ready. Click "Auto-Grab" to get your API key, then scrape a profile.</div>
        </div>
      </div>

      <div class="bl-blast-bar">
        <div class="bl-stats">
          <span>Sel: <strong id="bl-sel-count">0</strong></span>
          <span>Svcs: <strong id="bl-svc-count">0</strong></span>
          <span>Orders: <strong id="bl-order-count">0</strong></span>
        </div>
        <button class="bl-btn bl-btn-blast" id="bl-blast" disabled>‚ö° MASS SEND</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);

  // ‚îÄ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ
  const $ = id => document.getElementById(id);

  // ‚îÄ‚îÄ‚îÄ Toggle panel ‚îÄ‚îÄ‚îÄ
  toggle.addEventListener('click', () => overlay.classList.add('open'));
  $('bl-close').addEventListener('click', () => overlay.classList.remove('open'));
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('open'); });

  // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
  const ts = () => new Date().toLocaleTimeString('en-US', { hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit' });

  function log(msg, type = '') {
    const box = $('bl-log');
    const d = document.createElement('div');
    d.className = `bl-log-entry ${type}`;
    d.innerHTML = `<span class="bl-log-ts">[${ts()}]</span> ${msg}`;
    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
  }

  // ‚îÄ‚îÄ‚îÄ JAP API (same-origin, no CORS!) ‚îÄ‚îÄ‚îÄ
  async function japApi(params) {
    const key = $('bl-apikey').value.trim();
    if (!key) { log('No API key!', 'error'); return null; }
    try {
      const res = await fetch('https://justanotherpanel.com/api/v2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ key, ...params }).toString()
      });
      return await res.json();
    } catch (e) {
      log(`API error: ${e.message}`, 'error');
      return null;
    }
  }

  // ‚îÄ‚îÄ‚îÄ Auto-grab API key from JAP settings ‚îÄ‚îÄ‚îÄ
  $('bl-grab-key').addEventListener('click', async () => {
    const status = $('bl-key-status');
    status.textContent = 'Fetching settings page...';
    status.className = 'bl-key-status';

    try {
      const res = await fetch('https://justanotherpanel.com/settings', { credentials: 'include' });
      const html = await res.text();

      // Try to find API key in the settings page HTML
      // Common patterns: input field with API key value, or text containing the key
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // Look for input fields that might contain the API key
      let foundKey = '';

      // Check all input fields for API key patterns (long hex/alphanumeric strings)
      doc.querySelectorAll('input').forEach(inp => {
        const val = (inp.value || '').trim();
        // API keys are typically 32+ char hex/alphanumeric
        if (val.length >= 20 && /^[a-f0-9]+$/i.test(val)) {
          foundKey = val;
        }
      });

      // Also check for elements with specific labels/ids
      if (!foundKey) {
        doc.querySelectorAll('[id*="api"], [name*="api"], [class*="api"]').forEach(el => {
          const val = (el.value || el.textContent || '').trim();
          if (val.length >= 20 && /^[a-f0-9]+$/i.test(val)) {
            foundKey = val;
          }
        });
      }

      // Check for code/pre/span elements that might contain the key
      if (!foundKey) {
        doc.querySelectorAll('code, pre, span, div, p, td').forEach(el => {
          const val = (el.textContent || '').trim();
          if (val.length >= 20 && val.length <= 80 && /^[a-f0-9]+$/i.test(val)) {
            foundKey = val;
          }
        });
      }

      if (foundKey) {
        $('bl-apikey').value = foundKey;
        status.textContent = '‚úì API key auto-grabbed!';
        status.className = 'bl-key-status found';
        log('API key auto-grabbed from settings!', 'success');
        // Auto-check balance
        const bal = await japApi({ action: 'balance' });
        if (bal?.balance) {
          $('bl-balance').textContent = `Balance: $${parseFloat(bal.balance).toFixed(2)}`;
          log(`Balance: $${parseFloat(bal.balance).toFixed(2)}`, 'success');
        }
      } else {
        status.textContent = '‚úó Could not find key. Go to Settings > API and copy it manually.';
        status.className = 'bl-key-status missing';
        log('Could not auto-detect key. Paste it manually.', 'error');
        // Open settings in new tab for easy copy
        window.open('https://justanotherpanel.com/settings', '_blank');
      }
    } catch (e) {
      status.textContent = `‚úó Error: ${e.message}`;
      status.className = 'bl-key-status missing';
      log(`Grab failed: ${e.message}`, 'error');
    }
  });

  // ‚îÄ‚îÄ‚îÄ Check balance ‚îÄ‚îÄ‚îÄ
  $('bl-check-bal').addEventListener('click', async () => {
    log('Checking balance...');
    const data = await japApi({ action: 'balance' });
    if (data?.balance) {
      $('bl-balance').textContent = `Balance: $${parseFloat(data.balance).toFixed(2)}`;
      log(`Balance: $${parseFloat(data.balance).toFixed(2)}`, 'success');
    } else {
      log('Failed ‚Äî check API key.', 'error');
    }
  });

  // ‚îÄ‚îÄ‚îÄ TikTok Scraper via GM_xmlhttpRequest (bypasses CORS) ‚îÄ‚îÄ‚îÄ
  $('bl-scrape').addEventListener('click', async () => {
    const profileUrl = $('bl-profile').value.trim();
    if (!profileUrl || !profileUrl.includes('tiktok.com/@')) {
      log('Enter a valid TikTok profile URL.', 'error');
      return;
    }

    const btn = $('bl-scrape');
    const status = $('bl-scrape-status');
    const msg = $('bl-scrape-msg');

    btn.disabled = true;
    btn.textContent = '‚è≥ Scraping...';
    status.classList.add('visible');
    msg.textContent = 'Fetching profile page...';
    log(`Scraping: ${profileUrl}`, 'info');

    try {
      // Use GM_xmlhttpRequest to bypass CORS and fetch TikTok profile HTML
      const html = await new Promise((resolve, reject) => {
        GM_xmlhttpRequest({
          method: 'GET',
          url: profileUrl,
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          },
          onload: (res) => resolve(res.responseText),
          onerror: (err) => reject(new Error('Request failed')),
          ontimeout: () => reject(new Error('Request timed out')),
          timeout: 30000
        });
      });

      msg.textContent = 'Parsing video links...';

      // Extract video links from the HTML
      let links = [];

      // Method 1: Find video links in HTML href attributes
      const hrefRegex = /https?:\/\/(?:www\.)?tiktok\.com\/@[^\/]+\/video\/(\d+)/g;
      let match;
      while ((match = hrefRegex.exec(html)) !== null) {
        links.push(match[0]);
      }

      // Method 2: Parse JSON data embedded in the page (SIGI_STATE or __UNIVERSAL_DATA_FOR_REHYDRATION__)
      const jsonPatterns = [
        /<script id="__UNIVERSAL_DATA_FOR_REHYDRATION__"[^>]*>([\s\S]*?)<\/script>/,
        /<script id="SIGI_STATE"[^>]*>([\s\S]*?)<\/script>/,
        /window\['SIGI_STATE'\]\s*=\s*(\{[\s\S]*?\});/
      ];

      for (const pattern of jsonPatterns) {
        const jsonMatch = html.match(pattern);
        if (jsonMatch) {
          try {
            const data = JSON.parse(jsonMatch[1]);
            // Walk through the JSON to find video IDs
            const jsonStr = JSON.stringify(data);
            const vidIdRegex = /"id"\s*:\s*"(\d{17,22})"/g;
            let vidMatch;
            while ((vidMatch = vidIdRegex.exec(jsonStr)) !== null) {
              const username = profileUrl.match(/@([^\/\?]+)/)?.[1] || '';
              const vidUrl = `https://www.tiktok.com/@${username}/video/${vidMatch[1]}`;
              links.push(vidUrl);
            }
          } catch (e) { /* JSON parse failed, skip */ }
        }
      }

      // Deduplicate
      links = [...new Set(links)];

      if (links.length === 0) {
        log('No videos found in initial page. TikTok may require scrolling ‚Äî use manual paste instead.', 'error');
        log('Tip: Open profile in a tab, run the console scraper, paste links below.', 'info');

        // Provide the console script
        const consoleScript = `(async()=>{let p=0,s=0;while(s<3){window.scrollTo(0,document.body.scrollHeight);await new Promise(r=>setTimeout(r,1500));document.body.scrollHeight===p?s++:s=0;p=document.body.scrollHeight}const l=[...document.querySelectorAll('a[href*="/video/"]')].map(a=>a.href).filter((v,i,a)=>a.indexOf(v)===i);copy(l.join('\\n'));console.log(l.length+' links copied!')})()`;
        log(`Console script: open DevTools on the profile tab and paste this:`, 'info');
        console.log('TikTok Scraper Script (copy this):', consoleScript);
      } else {
        videos = links.map(url => ({ url, selected: true, status: 'idle', orders: [] }));
        renderVideos();
        updateStats();
        log(`‚úì Found ${links.length} videos from page HTML!`, 'success');

        if (links.length < 30) {
          log('Note: TikTok lazy-loads videos. For ALL videos, use the console scraper on the profile tab.', 'info');
        }
      }
    } catch (e) {
      log(`Scrape failed: ${e.message}`, 'error');
    }

    btn.disabled = false;
    btn.textContent = '‚ö° Scrape';
    status.classList.remove('visible');
  });

  // ‚îÄ‚îÄ‚îÄ Manual links ‚îÄ‚îÄ‚îÄ
  $('bl-load-links').addEventListener('click', () => {
    const raw = $('bl-links').value.trim();
    if (!raw) return;
    const links = raw.split('\n').map(l => l.trim()).filter(l => l.includes('/video/'));
    if (!links.length) { log('No valid links.', 'error'); return; }
    videos = links.map(url => ({ url, selected: true, status: 'idle', orders: [] }));
    renderVideos();
    updateStats();
    log(`Loaded ${links.length} videos.`, 'success');
  });

  // ‚îÄ‚îÄ‚îÄ Render videos ‚îÄ‚îÄ‚îÄ
  function renderVideos() {
    const c = $('bl-vid-table');
    if (!videos.length) {
      c.innerHTML = '<div class="bl-empty">No videos loaded yet.</div>';
      $('bl-vid-count').textContent = '0';
      return;
    }
    c.innerHTML = videos.map((v, i) => `
      <div class="bl-vid-row ${v.selected ? 'selected' : ''}">
        <input type="checkbox" ${v.selected ? 'checked' : ''} data-i="${i}" />
        <a href="${v.url}" target="_blank" class="bl-vid-link">${v.url.replace('https://www.tiktok.com/', '')}</a>
        <div class="bl-vid-status st-${v.status}">${v.status === 'idle' ? '‚Äî' : v.status === 'pending' ? '‚è≥' : v.status === 'sent' ? `‚úì ${v.orders.length}` : '‚úó'}</div>
      </div>
    `).join('');
    $('bl-vid-count').textContent = videos.length;
  }

  $('bl-vid-table').addEventListener('change', (e) => {
    const i = e.target.dataset.i;
    if (i !== undefined) {
      videos[parseInt(i)].selected = e.target.checked;
      renderVideos();
      updateStats();
    }
  });

  $('bl-sel-all').addEventListener('click', () => { videos.forEach(v => v.selected = true); renderVideos(); updateStats(); });
  $('bl-sel-none').addEventListener('click', () => { videos.forEach(v => v.selected = false); renderVideos(); updateStats(); });

  // ‚îÄ‚îÄ‚îÄ Services ‚îÄ‚îÄ‚îÄ
  $('bl-services').addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    if (btn.dataset.action === 'toggle') {
      btn.classList.toggle('active');
      btn.textContent = btn.classList.contains('active') ? '‚úì' : '‚úó';
      updateStats();
    }
    if (btn.dataset.action === 'remove') {
      btn.closest('.bl-svc-row').remove();
      updateStats();
    }
  });

  $('bl-add-svc').addEventListener('click', () => {
    const row = document.createElement('div');
    row.className = 'bl-svc-row';
    row.innerHTML = `
      <input type="text" class="bl-input svc-name" placeholder="Name" />
      <input type="text" class="bl-input svc-id" placeholder="ID" />
      <input type="number" class="bl-input svc-qty" value="500" placeholder="Qty" />
      <button class="bl-svc-btn active" data-action="toggle">‚úì</button>
      <button class="bl-svc-btn remove" data-action="remove">‚úï</button>
    `;
    $('bl-services').appendChild(row);
    updateStats();
  });

  function getActiveServices() {
    const svcs = [];
    document.querySelectorAll('.bl-svc-row').forEach(row => {
      const t = row.querySelector('[data-action="toggle"]');
      if (!t?.classList.contains('active')) return;
      const id = row.querySelector('.svc-id')?.value.trim();
      const qty = parseInt(row.querySelector('.svc-qty')?.value) || 0;
      const name = row.querySelector('.svc-name')?.value.trim() || 'Service';
      if (id && qty > 0) svcs.push({ id, qty, name });
    });
    return svcs;
  }

  function updateStats() {
    const sel = videos.filter(v => v.selected).length;
    const svcs = getActiveServices();
    $('bl-sel-count').textContent = sel;
    $('bl-svc-count').textContent = svcs.length;
    $('bl-order-count').textContent = sel * svcs.length;
    $('bl-blast').disabled = sel * svcs.length === 0;
  }

  document.addEventListener('input', (e) => {
    if (e.target.closest('.bl-svc-row')) updateStats();
  });

  // ‚îÄ‚îÄ‚îÄ MASS BLAST ‚îÄ‚îÄ‚îÄ
  $('bl-blast').addEventListener('click', async () => {
    const key = $('bl-apikey').value.trim();
    if (!key) { log('Set API key first!', 'error'); return; }

    const svcs = getActiveServices();
    if (!svcs.length) { log('No active services.', 'error'); return; }

    const selected = videos.filter(v => v.selected);
    if (!selected.length) { log('No videos selected.', 'error'); return; }

    const total = selected.length * svcs.length;
    log(`üöÄ Blasting: ${selected.length} videos √ó ${svcs.length} services = ${total} orders`, 'info');

    const btn = $('bl-blast');
    btn.disabled = true;
    btn.innerHTML = '<span class="bl-spinner"></span> SENDING...';

    let ok = 0, fail = 0;

    for (const video of selected) {
      video.status = 'pending';
      video.orders = [];
      renderVideos();

      let allGood = true;

      for (const svc of svcs) {
        try {
          const data = await japApi({ action: 'add', service: svc.id, link: video.url, quantity: svc.qty });
          if (data?.order) {
            video.orders.push({ service: svc.name, orderId: data.order });
            log(`‚úì #${data.order} ${svc.name} (${svc.qty}) ‚Üí ...${video.url.slice(-18)}`, 'success');
            ok++;
          } else {
            log(`‚úó ${svc.name} ‚Üí ${data?.error || 'Unknown error'}`, 'error');
            fail++;
            allGood = false;
          }
          await new Promise(r => setTimeout(r, 300));
        } catch (e) {
          log(`‚úó ${svc.name}: ${e.message}`, 'error');
          fail++;
          allGood = false;
        }
      }

      video.status = allGood ? 'sent' : 'error';
      renderVideos();
    }

    log(`üèÅ Done! ${ok} sent, ${fail} failed.`, ok > 0 ? 'success' : 'error');
    btn.innerHTML = '‚ö° MASS SEND';
    btn.disabled = false;

    // Refresh balance
    const bal = await japApi({ action: 'balance' });
    if (bal?.balance) $('bl-balance').textContent = `Balance: $${parseFloat(bal.balance).toFixed(2)}`;
  });

  // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
  updateStats();
  log('TikTok Blaster loaded. You\'re on JAP ‚Äî API calls go same-origin, no CORS issues.', 'info');

})();
